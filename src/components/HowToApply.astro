---
const deadlineText = "Monday, 26 January 2026";

const steps = [
  {
    id: "step-01",
    short: "Start the form",
    title: "Click “Apply” and complete the form",
    body:
      "Carefully work through each question. Double-check your information, and be truthful throughout. You must complete every required field before you can submit.",
  },
  {
    id: "step-02",
    short: "Check email",
    title: "Watch for your confirmation email",
    body:
      "Within minutes you’ll receive a confirmation email from ILM-SA. Read it in full and keep it handy — everything else happens via that thread.",
  },
  {
    id: "step-03",
    short: "Prepare documents",
    title: "Gather the requested documents",
    body:
      "Ensure your scans/photos are clear and legible. Use good light and flat surfaces. Keep files within size limits.",
    bullets: [
      "Accepted formats: <strong>PDF, Word, JPG</strong>",
      "Suggested naming: <code>Lastname_Firstname_DocumentType.pdf</code>",
    ],
    documents: [
      "Identity document <em>(certified)</em>",
      "Proof of residence <em>(bank statement, utility bill, etc.)</em>",
      "Last three months bank statements",
      "Character testimonial from your teacher/lecturer <em>(must include his/her contact details)</em>",
      "Character testimonial from a community/religious figure <em>(must include his/her contact details)</em>",
      "Matric certificate <em>(for applicants who have this in their possession)*</em>",
      "Matric trial examination report <em>(for applicants who don’t yet have their matric certificates)</em>",
      "Academic record from the tertiary institution at which you are studying <em>(if applicable)</em>",
      "Letter of acceptance from relevant institution",
    ],
    footnote:
      '* Please email your matric certificate to <a class="underline text-[--brand-primary]" href="mailto:admin@ilmsa.co.za">admin@ilmsa.co.za</a> as soon as you receive it.',
  },
  {
    id: "step-04",
    short: "Submit docs",
    title: "Reply with your supporting documents",
    body:
      "Reply directly to the confirmation email with all attachments and keep the subject line unchanged. Send one consolidated reply instead of several partial emails.",
  },
  {
    id: "step-05",
    short: "Wait for outcome",
    title: "Await shortlist updates & interviews",
    body:
      `If shortlisted, we’ll contact you by <span class="inline-block rounded px-1.5 py-0.5 bg-[color-mix(in_lch,var(--brand-secondary)_18%,white)] font-semibold text-[--brand-secondary]">${deadlineText}</span> to arrange an interview. No news by then means your application was not successful this time.`,
  },
];
---

<section id="how-to-apply" class="relative mx-auto max-w-6xl px-4 py-20 scroll-mt-28">
  <!-- soft background glow -->
  <div class="pointer-events-none absolute inset-0 -z-10 rounded-[2rem] blur-3xl opacity-70"
       style="background: color-mix(in lch, var(--brand-secondary) 24%, white)"></div>

  <div class="relative grid grid-cols-1 gap-10 md:grid-cols-12">
    <!-- Sticky rail -->
    <aside class="md:col-span-4 lg:col-span-3">
      <div class="sticky top-28">
        <h2 class="mb-3 text-xs font-semibold uppercase tracking-[0.3em] text-[--brand-secondary]">
          Application · Steps
        </h2>
        <ol class="relative pl-6 text-sm text-[#0b1d2a]">
          <div class="absolute left-2 top-0 h-full w-[2px] bg-[color-mix(in_lch,var(--brand-secondary)_30%,white)]"></div>
          {steps.map((s, i) => (
            <li class="group relative mb-6 last:mb-0" data-rail-item={s.id}>
              <span class="absolute -left-[6px] mt-[2px] inline-flex h-3.5 w-3.5 items-center justify-center rounded-full ring-2 ring-[--brand-secondary]/30">
                <span class="rail-dot h-2.5 w-2.5 rounded-full bg-[--brand-secondary] opacity-40 transition-all group-[.is-active]:opacity-100 group-[.is-active]:scale-110"></span>
              </span>
              <a href={`#${s.id}`} class="inline-block translate-x-0 transition-transform hover:translate-x-[2px] focus:translate-x-[2px]">
                <span class="block text-[0.72rem] uppercase tracking-[0.22em] text-[--brand-secondary]/80">
                  {String(i + 1).padStart(2, "0")}
                </span>
                <span class="relative block font-medium text-[#05141c] transition-colors group-[.is-active]:text-[--brand-secondary]">
                  <span class="underline-anim pointer-events-none absolute -bottom-0.5 left-0 block h-[2px] w-0 bg-[--brand-secondary] transition-[width] group-[.is-active]:w-full"></span>
                  {s.short}
                </span>
              </a>
            </li>
          ))}
        </ol>

        <!-- Mobile progress -->
        <div class="mt-6 block h-1 w-full rounded-full bg-black/10 md:hidden">
          <div id="steps-progress" class="h-1 w-0 rounded-full bg-[--brand-secondary] transition-[width]"></div>
        </div>
      </div>
    </aside>

    <!-- Scroll panels -->
    <div class="md:col-span-8 lg:col-span-9">
      <div class="space-y-16">
        {steps.map((s, idx) => (
          <section
            id={s.id}
            data-step={s.id}
            class="step-panel relative scroll-mt-28 rounded-3xl border border-[color-mix(in_lch,var(--brand-secondary)_18%,white)] bg-white/90 p-6 shadow-[0_12px_45px_rgba(11,29,42,0.08)] backdrop-blur will-change-transform will-change-opacity"
            style="--num-offset: 0px"
          >
            <!-- smaller ghost numeral with parallax -->
            <span aria-hidden="true"
              class="step-num pointer-events-none absolute right-4 top-3 select-none text-4xl font-extrabold leading-none text-[--brand-secondary]/10 md:text-5xl"
              style="transform: translateY(var(--num-offset));"
            >
              {String(idx + 1).padStart(2, "0")}
            </span>

            <header class="mb-3">
              <h3 class="text-2xl font-bold tracking-tight text-[#05141c]">{s.title}</h3>
            </header>

            <div class="prose prose-sm max-w-none text-[0.98rem] leading-7 text-[#13313f]/90 prose-p:my-0 prose-code:before:content-[''] prose-code:after:content-['']">
              <p set:html={s.body}></p>

              {s.bullets && (
                <ul class="mt-4 space-y-2 text-[#0b1d2a]">
                  {s.bullets.map((b, i) => (
                    <li class="reveal-li flex items-start gap-3 opacity-0 translate-y-3" style={`transition-delay: ${i * 60}ms`}>
                      <span class="mt-[6px] inline-block h-1.5 w-5 flex-none rounded-full bg-[--brand-secondary]"></span>
                      <span set:html={b}></span>
                    </li>
                  ))}
                </ul>
              )}

              {s.documents && (
                <div class="doc-box mt-6 rounded-2xl border border-[color-mix(in_lch,var(--brand-primary)_22%,white)] bg-[color-mix(in_lch,var(--brand-primary)_9%,white)] p-4">
                  <p class="mb-3 text-sm font-semibold text-[--brand-primary]">
                    Please upload the following documents with your application:
                  </p>
                  <ul class="space-y-2 text-[#0b1d2a]">
                    {s.documents.map((d, i) => (
                      <li class="reveal-li flex items-start gap-3 opacity-0 translate-y-3" style={`transition-delay: ${i * 40}ms`}>
                        <span class="mt-[6px] inline-block h-1.5 w-5 flex-none rounded-full bg-[--brand-primary]"></span>
                        <span set:html={d}></span>
                      </li>
                    ))}
                  </ul>
                  {s.footnote && (
                    <p class="mt-3 text-sm italic text-[#0b1d2a]/80" set:html={s.footnote}></p>
                  )}
                </div>
              )}
            </div>

            <!-- animated gradient accent -->
            <div class="accent-line mt-6 h-[2px] w-12 bg-gradient-to-r from-[--brand-secondary] via-[--brand-primary] to-transparent opacity-60 transition-[width] duration-500 ease-out"></div>
          </section>
        ))}
      </div>
    </div>
  </div>
</section>

<script is:inline>
  (function () {
    const root = document.getElementById('how-to-apply');
    if (!root) return;

    const panels = Array.from(root.querySelectorAll('[data-step]'));
    const railItems = new Map(Array.from(root.querySelectorAll('[data-rail-item]')).map(el => [el.getAttribute('data-rail-item'), el]));
    const progressEl = document.getElementById('steps-progress');

    // Initial motion state (fade/slide/scale)
    panels.forEach((el, i) => {
      el.style.opacity = '0';
      el.style.transform = 'translateY(28px) scale(0.985)';
      el.style.transition = 'opacity 700ms cubic-bezier(0.2,0.65,0.3,1), transform 700ms cubic-bezier(0.2,0.65,0.3,1)';
      el.style.transitionDelay = `${i * 70}ms`;

      // Prepare staggered bullets inside this panel
      const lis = el.querySelectorAll('.reveal-li');
      lis.forEach(li => {
        li.style.transition = 'opacity 500ms cubic-bezier(0.2,0.65,0.3,1), transform 500ms cubic-bezier(0.2,0.65,0.3,1)';
      });
    });

    const setActiveRail = (id) => {
      railItems.forEach(n => n.classList.remove('is-active'));
      const node = railItems.get(id);
      if (node) node.classList.add('is-active');
    };

    // Reveal panels on enter + grow accent, reveal bullets
    const ioReveal = new IntersectionObserver((entries) => {
      entries.forEach((e) => {
        if (e.isIntersecting) {
          const el = e.target;
          el.style.opacity = '1';
          el.style.transform = 'translateY(0) scale(1)';

          // Accent line grow
          const accent = el.querySelector('.accent-line');
          if (accent) accent.style.width = '96px';

          // Reveal staggered list items
          el.querySelectorAll('.reveal-li').forEach((li) => {
            li.style.opacity = '1';
            li.style.transform = 'translateY(0)';
          });
        }
      });
    }, { rootMargin: '0px 0px -12% 0px', threshold: 0.22 });
    panels.forEach(p => ioReveal.observe(p));

    // Sync active rail item
    const ioActive = new IntersectionObserver((entries) => {
      entries.forEach((e) => {
        if (e.isIntersecting) {
          const id = e.target.getAttribute('data-step');
          setActiveRail(id);
        }
      });
    }, { threshold: 0.55 });
    panels.forEach(p => ioActive.observe(p));

    // Parallax drift for ghost numbers (cheap + smooth)
    let ticking = false;
    const onScroll = () => {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(() => {
        panels.forEach((el) => {
          const rect = el.getBoundingClientRect();
          const vh = window.innerHeight || 1;
          // progress from -1 (above) to +1 (below)
          const center = rect.top + rect.height / 2;
          const prog = (center - vh / 2) / (vh / 2);
          // clamp and map to px offset
          const offset = Math.max(-1, Math.min(1, prog)) * 12; // ±12px
          el.style.setProperty('--num-offset', offset.toFixed(1) + 'px');
        });
        // Mobile progress bar
        if (progressEl) {
          const scroller = root;
          const r = scroller.getBoundingClientRect();
          const vh = window.innerHeight || 1;
          const total = r.height - vh;
          const passed = Math.min(Math.max(vh - r.top, 0), r.height);
          const pct = total > 0 ? Math.min((passed / total) * 100, 100) : 0;
          progressEl.style.width = pct + '%';
        }
        ticking = false;
      });
    };
    onScroll();
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onScroll);

    // Accessibility: focus outline on rail links
    root.querySelectorAll('[data-rail-item] a').forEach((a) => {
      a.addEventListener('focus', () => a.parentElement?.classList.add('is-active'));
      a.addEventListener('blur',  () => a.parentElement?.classList.remove('is-active'));
    });
  })();
</script>

<style>
  /* Reduced motion: show everything without transforms */
  @media (prefers-reduced-motion: reduce) {
    #how-to-apply [data-step] {
      opacity: 1 !important;
      transform: none !important;
      transition: none !important;
    }
    #how-to-apply .reveal-li {
      opacity: 1 !important;
      transform: none !important;
      transition: none !important;
    }
    #how-to-apply .accent-line { width: 96px !important; }
  }

  /* Focus ring on rail links */
  #how-to-apply [data-rail-item] a:focus {
    outline: 2px solid color-mix(in lch, var(--brand-secondary) 55%, white);
    outline-offset: 3px;
    border-radius: 0.5rem;
  }

  /* Pulse for active rail dot (subtle) */
  #how-to-apply .is-active .rail-dot {
    animation: railPulse 1.6s ease-in-out infinite;
  }
  @keyframes railPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
    50% { box-shadow: 0 0 0 6px color-mix(in lch, var(--brand-secondary) 16%, transparent); }
  }
</style>
